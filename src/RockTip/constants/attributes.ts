/*
Copyright (c) [hrabia_kamien](https://github.com/git-kamien). All rights reserved.

The author hereby grants the recipient ("Licensee") a non-exclusive, non-transferable,
royalty-free license to use, modify, and incorporate this software into private and
commercial projects. The Licensee is permitted to make modifications solely for
adaptation, optimization, or enhancement, provided that such modifications do not
infringe upon the original author's rights.

This license applies exclusively to the entity that has lawfully obtained the source
code directly from the rightful author. Redistribution, sublicensing, or transfer
of this software, whether in its original or modified form, is strictly prohibited
without the explicit written consent of the author.

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

-----BEGIN PGP PUBLIC KEY BLOCK-----
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
=krDL
-----END PGP PUBLIC KEY BLOCK-----
*/

import type {ItemPayload} from "../typings/payloads";

export namespace Attributes {
    export namespace Typings {
        export type OrderEntry = {
            priority: number,
            name: string
        };
    }


    const orderDataset: Record<string, Attributes.Typings.OrderEntry[]> = {
        "actions": [
            {"priority": 1, "name": "multiplyExperienceAfterNextKill"},
            {"priority": 1, "name": "incrementEnchancementExp"},
            {"priority": 1, "name": "incrementDraconite"},
            {"priority": 1, "name": "incrementFatigue"},
            {"priority": 1, "name": "incrementStamina"},
            {"priority": 1, "name": "previewLootbox"},
            {"priority": 1, "name": "combatSelfHeal"},
            {"priority": 1, "name": "incrementGold"},
            {"priority": 1, "name": "openDeposit"},
            {"priority": 1, "name": "openAuction"},
            {"priority": 1, "name": "teleportTo"},
            {"priority": 1, "name": "combatFlee"},
            {"priority": 1, "name": "useEmotion"},
            {"priority": 1, "name": "useOutfit"},
            {"priority": 1, "name": "npcLocate"},
            {"priority": 1, "name": "playAudio"},
            {"priority": 1, "name": "openBook"},
            {"priority": 1, "name": "openMail"},
            {"priority": 1, "name": "usePet"}
        ],
        "bonuses": [
            {"priority": 12, "name": "maxQuantity"},
            {"priority": 12, "name": "quantity"},
            {"priority": 11, "name": "legendaryBon"},
            {"priority": 11, "name": "lootedWith"},
            {"priority": 11, "name": "description"},
            {"priority": 10, "name": "teleportTo"},
            {"priority": 10, "name": "attackSpeed"},
            {"priority": 10, "name": "heal2TurnsReduction"},
            {"priority": 10, "name": "enemyAttackSpeedReduction"},
            {"priority": 10, "name": "deepWoundChance"},
            {"priority": 9, "name": "destroyArmorReduction"},
            {"priority": 9, "name": "chanceToBlockPuncture"},
            {"priority": 9, "name": "healthPerStrength"},
            {"priority": 9, "name": "armorPuncture"},
            {"priority": 9, "name": "enemyManaReduction"},
            {"priority": 8, "name": "criticalReductionDuringDefending"},
            {"priority": 8, "name": "manaEnergyDestroyReduction"},
            {"priority": 8, "name": "magicalResistanceReduction"},
            {"priority": 8, "name": "combatHealthRestoration"},
            {"priority": 8, "name": "combatHealthReduction"},
            {"priority": 8, "name": "enemyEvasionReduction"},
            {"priority": 8, "name": "critPowerReduction"},
            {"priority": 7, "name": "evadePoints"},
            {"priority": 7, "name": "health"},
            {"priority": 7, "name": "energy"},
            {"priority": 7, "name": "mana"},
            {"priority": 6, "name": "energyDestroy"},
            {"priority": 5, "name": "allBaseAttributes"},
            {"priority": 5, "name": "intellect"},
            {"priority": 5, "name": "strength"},
            {"priority": 5, "name": "agility"},
            {"priority": 4, "name": "blockPoints"},
            {"priority": 3, "name": "physicalDamageAbsorption"},
            {"priority": 3, "name": "magicalDamageAbsorption"},
            {"priority": 3, "name": "incrementGold"},
            {"priority": 3, "name": "physicalCritPower"},
            {"priority": 3, "name": "magicalCritPower"},
            {"priority": 2, "name": "poisonResistance"},
            {"priority": 2, "name": "lightResistance"},
            {"priority": 2, "name": "frostResistance"},
            {"priority": 2, "name": "fireResistance"},
            {"priority": 2, "name": "absorptionDestroy"},
            {"priority": 2, "name": "chanceToCounter"},
            {"priority": 2, "name": "defenseDestroy"},
            {"priority": 2, "name": "criticalChance"},
            {"priority": 1, "name": "healthRestorationPercent"},
            {"priority": 1, "name": "fasterRevivalRecovery"},
            {"priority": 1, "name": "healChanceAfterFight"},
            {"priority": 1, "name": "restoreHealthPoints"},
            {"priority": 1, "name": "arrowPhysicalDamage"},
            {"priority": 1, "name": "physicalDamage"},
            {"priority": 1, "name": "poisonDamage"},
            {"priority": 1, "name": "lightDamage"},
            {"priority": 1, "name": "frostDamage"},
            {"priority": 1, "name": "fireDamage"},
            {"priority": 1, "name": "keyDescription"},
            {"priority": 1, "name": "shortenRevival"},
            {"priority": 1, "name": "healRemaining"},
            {"priority": 1, "name": "bagCapacity"},
            {"priority": 1, "name": "timelimit"},
            {"priority": 1, "name": "defense"},
            /* Ignored - not have a translation to be even prioritized */
            {"priority": 0, "name": "upgradePercent"},
            {"priority": 0, "name": "lootedAt"},
            {"priority": 3, "name": "isUnidentified"},
        ],
        "limits": [
            {"priority": 1, "name": "needProfessions"},
            {"priority": 1, "name": "limitedToMaps"},
            {"priority": 1, "name": "needIntellect"},
            {"priority": 1, "name": "needStrength"},
            {"priority": 1, "name": "cooldownTime"},
            {"priority": 1, "name": "expirationAt"},
            {"priority": 1, "name": "needInQuest"},
            {"priority": 1, "name": "needAgility"},
            {"priority": 1, "name": "needLevel"}
        ],
        "tags": [
            {"priority": 2, "name": "isNonStoreableInClanDeposit"},
            {"priority": 1, "name": "isBindPermamentlyAfterBuy"},
            {"priority": 2, "name": "isNonStoreableInDeposit"},
            {"priority": 1, "name": "isPermamentlyBounded"},
            {"priority": 2, "name": "isLowerLevelScroll"},
            {"priority": 1, "name": "isBindsAfterEquip"},
            {"priority": 2, "name": "isUnbindingScroll"},
            {"priority": 2, "name": "isNotAuctionable"},
            {"priority": 1, "name": "isBoundToOwner"},
            {"priority": 2, "name": "isSummonScroll"},
            {"priority": 2, "name": "isUnbindScroll"},
            {"priority": 2, "name": "isUndoScroll"},
            {"priority": 2, "name": "isRecovered"},
            {"priority": 2, "name": "isCursed"},
        ]
    };

    export function getOrdersList(itemData: ItemPayload): {
        actions: Typings.OrderEntry[][];
        // bonuses: Typings.OrderEntry[][];
        bonuses: string[];
        // limits: Typings.OrderEntry[][];
        limits: string[];
        // tags: Typings.OrderEntry[][];
        tags: string[];
    } {
        function getOrdersByCategory(target: keyof typeof orderDataset): Attributes.Typings.OrderEntry[][] {
            const resultList = [];
            for (let orderIndex = 1; orderIndex !== Math.max(...orderDataset[target].map(entryData => entryData.priority)) + 1; orderIndex++) {
                resultList.push(
                    // @ts-ignore
                    Object.values(orderDataset[target]).filter(entryData => entryData.priority === orderIndex)
                );
            }

            return resultList;
        }

        const orderList = {
            "result": {
                "actions": getOrdersByCategory("actions"),
                "bonuses": getOrdersByCategory("bonuses"),
                "limits": getOrdersByCategory("limits"),
                "tags": getOrdersByCategory("tags")
            }
        };

        const result: {
            actions: Attributes.Typings.OrderEntry[][]
            bonuses: string[]
            limits: string[]
            tags: string[]
        } = {
            actions: [],
            bonuses: [],
            limits: [],
            tags: [],
        }

        for (const [orderName, orderValue] of Object.entries(orderList.result)) {
            for (let priorityOffset = 0; priorityOffset !== orderValue.length; priorityOffset++) {
                const currentOrder = orderValue[priorityOffset];
                for (let attributeOffset = 0; attributeOffset !== currentOrder.length; attributeOffset++) {
                    const currentAttributeName = currentOrder[attributeOffset];
                    if (itemData.schema.inner.attributes[currentAttributeName.name]) {
                        continue;
                    }

                    delete orderList.result[orderName][priorityOffset][attributeOffset];
                }

                result[orderName][priorityOffset] = orderList.result[orderName][priorityOffset]
                    .filter((currentOrder: Attributes.Typings.OrderEntry) => currentOrder);
            }

            result[orderName] = orderList.result[orderName]
                .flatMap((currentOrder: Attributes.Typings.OrderEntry) => currentOrder)
                .map((currentOrder: Attributes.Typings.OrderEntry) => currentOrder.name);
        }

        return result;
    }
}

